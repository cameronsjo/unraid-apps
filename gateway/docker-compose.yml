# MCP Gateway Stack
#
# Deploy:  scp to Unraid, then: docker compose up -d
# Logs:    docker compose logs -f
# Restart: docker compose restart
#
# Config files live in /mnt/user/appdata/* on Unraid

networks:
  mcp-net:
    name: mcp-net
    driver: bridge

services:
  # =============================================================================
  # INGRESS - Tailscale Funnel
  # =============================================================================
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale-mcp
    hostname: mcp-gateway
    restart: unless-stopped
    networks:
      - mcp-net
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - TZ=America/Chicago
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_HOSTNAME=mcp-gateway
      - TS_EXTRA_ARGS=--advertise-tags=tag:funnel
    volumes:
      - /mnt/user/appdata/tailscale-mcp/state:/var/lib/tailscale
      - /mnt/user/appdata/tailscale-mcp/serve.json:/config/serve.json:ro

  # =============================================================================
  # AUTH - Authelia OIDC
  # =============================================================================
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    networks:
      - mcp-net
    depends_on:
      - redis
    environment:
      - TZ=America/Chicago
    volumes:
      - /mnt/user/appdata/authelia:/config

  redis:
    image: redis:alpine
    container_name: redis-mcp
    restart: unless-stopped
    networks:
      - mcp-net
    ports:
      - "6379:6379"
    volumes:
      - /mnt/user/appdata/redis-mcp:/data

  # =============================================================================
  # GATEWAY - agentgateway with JWT validation
  # =============================================================================
  agentgateway:
    image: ghcr.io/agentgateway/agentgateway:latest
    container_name: agentgateway
    restart: unless-stopped
    networks:
      - mcp-net
    ports:
      - "8080:8080"
      - "15000:15000"
    environment:
      - TZ=America/Chicago
      - RUST_LOG=info
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://signoz-otel-collector:4317
      - OTEL_SERVICE_NAME=agentgateway
    volumes:
      - /mnt/user/appdata/agentgateway/config.yaml:/etc/agentgateway/config.yaml:ro
      - /mnt/user/appdata/agentgateway/jwks.json:/etc/agentgateway/jwks.json:ro
    command: ["-f", "/etc/agentgateway/config.yaml"]

  # =============================================================================
  # MCP BACKENDS
  # =============================================================================
  obsidian:
    image: lscr.io/linuxserver/obsidian
    container_name: obsidian
    restart: unless-stopped
    networks:
      - mcp-net
    ports:
      - "3011:3000"
      - "3012:3001"
    environment:
      - TZ=America/Chicago
      - PUID=99
      - PGID=100
    volumes:
      - /mnt/user/appdata/obsidian:/config

  obsidian-mcp:
    image: ghcr.io/cameronsjo/obsidian-mcp:latest
    container_name: obsidian-mcp
    restart: unless-stopped
    network_mode: "service:obsidian"
    depends_on:
      - obsidian
    environment:
      - PORT=3002
      - OBSIDIAN_API_KEY=${OBSIDIAN_API_KEY}
      - OBSIDIAN_HOST=127.0.0.1
      - OBSIDIAN_USE_HTTP=true
      - NODE_TLS_REJECT_UNAUTHORIZED=0

  mouse-mcp:
    image: ghcr.io/cameronsjo/mouse-mcp:latest
    container_name: mouse-mcp
    restart: unless-stopped
    networks:
      - mcp-net
    environment:
      - NODE_ENV=production
      - MOUSE_MCP_TRANSPORT=http
      - MOUSE_MCP_PORT=3000
      - MOUSE_MCP_HOST=0.0.0.0
      - MOUSE_MCP_DB_PATH=/app/.data/disney.db
      - MOUSE_MCP_SENTRY_DSN=${MOUSE_MCP_SENTRY_DSN:-}
    volumes:
      - /mnt/user/appdata/mouse-mcp:/app/.data

  media-mcp:
    image: ghcr.io/cameronsjo/media-mcp:latest
    container_name: media-mcp
    restart: unless-stopped
    networks:
      - mcp-net
    environment:
      - NODE_ENV=production
      - MCP_TRANSPORT=http
      - MCP_HTTP_PORT=3000
      - MCP_HTTP_HOST=0.0.0.0
      - MCP_HTTP_PATH=/mcp
      - MCP_CACHE_ENABLED=true
      - MCP_CACHE_PATH=/app/cache/cache.db
      - TMDB_API_KEY=${TMDB_API_KEY}
      - SENTRY_DSN=${SENTRY_DSN:-}
      - LOG_LEVEL=info
    volumes:
      - /mnt/user/appdata/media-mcp/cache:/app/cache
