# Authelia Configuration for MCP Gateway
#
# Working configuration for Claude.ai OIDC integration.
# Replace YOUR_TAILNET and secrets before deploying.
#
# Required secrets (generate your own):
#   - session.secret (64 char hex)
#   - storage.encryption_key (64 char hex)
#   - identity_validation.reset_password.jwt_secret (64 char hex)
#   - identity_providers.oidc.jwks[].key (RSA private key)
#   - identity_providers.oidc.clients[].client_secret (argon2id hash)
#
# Generate secrets:
#   openssl rand -hex 32
#   docker run --rm authelia/authelia:latest crypto hash generate argon2 --password 'YOUR_SECRET'

server:
  address: "tcp://0.0.0.0:9091"

# =============================================================================
# Logging
# =============================================================================
log:
  level: info
  format: json

# =============================================================================
# Authentication Backend
# =============================================================================
authentication_backend:
  file:
    path: /config/users.yml
    password:
      algorithm: argon2id

password_policy:
  standard:
    enabled: true
    min_length: 12
    require_uppercase: true
    require_lowercase: true
    require_number: true
    require_special: true


regulation:
  max_retries: 3
  find_time: 2m
  ban_time: 5m

# =============================================================================
# Session
# =============================================================================
session:
  name: authelia_session
  same_site: strict
  secret: "REPLACE_WITH_64_CHAR_HEX_SECRET"
  expiration: 1h
  inactivity: 5m
  remember_me: 24h
  cookies:
    - domain: "YOUR_TAILNET.ts.net"
      authelia_url: "https://mcp-gateway.YOUR_TAILNET.ts.net"
  redis:
    host: redis-mcp
    port: 6379

# =============================================================================
# Storage
# =============================================================================
storage:
  encryption_key: "REPLACE_WITH_64_CHAR_HEX_SECRET"
  local:
    path: /config/db.sqlite3

access_control:
  default_policy: one_factor

# =============================================================================
# Notifier (for password resets - use file for simple setups)
# =============================================================================
notifier:
  filesystem:
    filename: /config/notification.txt

identity_validation:
  reset_password:
    jwt_secret: "REPLACE_WITH_64_CHAR_HEX_SECRET"


# =============================================================================
# TOTP (Two-Factor)
# =============================================================================
totp:
  disable: true
  issuer: "MCP Gateway"
identity_providers:
  oidc:
    jwks:
      - key_id: "main"
        algorithm: "RS256"
        use: "sig"
        key: |
          -----BEGIN PRIVATE KEY-----
          REPLACE_WITH_RSA_PRIVATE_KEY
          Generate with: openssl genrsa -out private.pem 4096
          -----END PRIVATE KEY-----

    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
        - userinfo
      allowed_origins_from_client_redirect_uris: true

    lifespans:
      access_token: 15m
      refresh_token: 1d
      id_token: 15m

    clients:
      - client_id: "claude-mcp-client"
        client_name: "Claude.ai MCP"
        # Generate with: docker run --rm authelia/authelia:latest crypto hash generate argon2 --password 'YOUR_SECRET'
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$REPLACE_WITH_HASH'
        public: false
        authorization_policy: "one_factor"
        redirect_uris:
          - "https://claude.ai/api/mcp/auth_callback"
          - "https://api.anthropic.com/oauth/callback"
        # IMPORTANT: Claude.ai requests these scopes - all must be allowed
        scopes:
          - "openid"
          - "profile"
          - "email"
          - "address"
          - "phone"
          - "groups"
          - "offline_access"
        grant_types:
          - "authorization_code"
          - "refresh_token"
        response_types:
          - "code"
        token_endpoint_auth_method: "client_secret_post"
        userinfo_signed_response_alg: "none"
