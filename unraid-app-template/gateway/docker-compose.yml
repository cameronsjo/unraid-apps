# MCP Gateway Stack
#
# Tailscale Funnel → Authelia (OIDC) → agentgateway (CEL) → MCP backends
#
# Usage:
#   1. Generate secrets (see ../scripts/generate-secrets.sh)
#   2. Configure .env (copy from .env.example)
#   3. Replace YOUR_TAILNET in all config files
#   4. docker compose up -d

services:
  # ===========================================================================
  # Tailscale - Ingress via Funnel
  # ===========================================================================
  tailscale-mcp:
    image: tailscale/tailscale:latest
    container_name: tailscale-mcp
    hostname: mcp-gateway
    restart: unless-stopped
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_USERSPACE=false
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./tailscale-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - mcp-gateway

  # ===========================================================================
  # Authelia - OIDC Provider + Authentication
  # ===========================================================================
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    volumes:
      - ./authelia/configuration.yml:/config/configuration.yml:ro
      - ./authelia/users.yml:/config/users.yml:ro
      - ./authelia/secrets:/secrets:ro
      - authelia-data:/data
    environment:
      - TZ=America/Chicago
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET_FILE=/secrets/hmac
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY_FILE=/secrets/issuer.pem
    networks:
      - mcp-gateway
    depends_on:
      - redis

  # ===========================================================================
  # Redis - Session Storage for Authelia
  # ===========================================================================
  redis:
    image: redis:alpine
    container_name: redis-mcp
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - mcp-gateway

  # ===========================================================================
  # agentgateway - MCP Multiplexer + Authorization
  # ===========================================================================
  agentgateway:
    image: ghcr.io/agentgateway/agentgateway:latest
    container_name: agentgateway
    restart: unless-stopped
    volumes:
      - ./agentgateway.yaml:/config/agentgateway.yaml:ro
    environment:
      - CONFIG_PATH=/config/agentgateway.yaml
    networks:
      - mcp-gateway
      - mcp-internal
    depends_on:
      - authelia

  # ===========================================================================
  # Example MCP Backend - Obsidian
  # ===========================================================================
  # obsidian-mcp:
  #   image: ghcr.io/YOUR_USERNAME/obsidian-mcp:latest
  #   container_name: obsidian-mcp
  #   restart: unless-stopped
  #   volumes:
  #     - /mnt/user/documents/obsidian:/vault:ro
  #   environment:
  #     - VAULT_PATH=/vault
  #   networks:
  #     - mcp-internal

  # ===========================================================================
  # Example MCP Backend - Home Assistant
  # ===========================================================================
  # homeassistant-mcp:
  #   image: ghcr.io/YOUR_USERNAME/homeassistant-mcp:latest
  #   container_name: homeassistant-mcp
  #   restart: unless-stopped
  #   environment:
  #     - HASS_URL=http://homeassistant:8123
  #     - HASS_TOKEN=${HASS_TOKEN}
  #   networks:
  #     - mcp-internal

networks:
  # Public-facing network (Tailscale → Authelia → agentgateway)
  mcp-gateway:
    driver: bridge

  # Internal network (agentgateway → MCP backends)
  mcp-internal:
    driver: bridge
    internal: true  # No external access

volumes:
  tailscale-state:
  authelia-data:
  redis-data:
