# Authelia Configuration for MCP Gateway
#
# OIDC provider for Claude.ai and other MCP clients.
# Replace YOUR_TAILNET with your actual Tailnet name.
#
# Documentation: https://www.authelia.com/configuration/

# =============================================================================
# Server
# =============================================================================
server:
  address: 'tcp://:9091'

# =============================================================================
# Logging
# =============================================================================
log:
  level: info
  format: json

# =============================================================================
# Authentication Backend
# =============================================================================
authentication_backend:
  file:
    path: /config/users.yml
    password:
      algorithm: argon2id
      iterations: 3
      memory: 65536
      parallelism: 4
      key_length: 32
      salt_length: 16

# =============================================================================
# Session
# =============================================================================
session:
  name: authelia_session
  secret: insecure_session_secret_change_me  # Will be overridden by env
  expiration: 1h
  inactivity: 5m
  remember_me: 1M
  cookies:
    - domain: 'YOUR_TAILNET.ts.net'
      authelia_url: 'https://mcp-gateway.YOUR_TAILNET.ts.net/auth'
  redis:
    host: redis
    port: 6379

# =============================================================================
# Storage
# =============================================================================
storage:
  local:
    path: /data/db.sqlite3

# =============================================================================
# Notifier (for password resets - use file for simple setups)
# =============================================================================
notifier:
  filesystem:
    filename: /data/notification.txt

# =============================================================================
# Access Control
# =============================================================================
access_control:
  default_policy: deny
  rules:
    # Allow OIDC endpoints
    - domain: 'mcp-gateway.YOUR_TAILNET.ts.net'
      policy: bypass
      resources:
        - '^/auth/api/oidc/.*$'
        - '^/auth/.well-known/.*$'

    # Require two-factor for everything else
    - domain: 'mcp-gateway.YOUR_TAILNET.ts.net'
      policy: two_factor

# =============================================================================
# TOTP (Two-Factor)
# =============================================================================
totp:
  issuer: 'MCP Gateway'
  period: 30
  skew: 1

# =============================================================================
# Identity Providers (OIDC)
# =============================================================================
identity_providers:
  oidc:
    # HMAC secret loaded from file via environment variable
    # hmac_secret: loaded from AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET_FILE

    # Issuer private key loaded from file via environment variable
    # issuer_private_key: loaded from AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY_FILE

    # Access token lifespan
    access_token_lifespan: 1h

    # Refresh token lifespan
    refresh_token_lifespan: 90m

    # Enable PKCE enforcement
    enforce_pkce: public_clients_only

    # Clients
    clients:
      # MCP Gateway client (for Claude.ai and other MCP clients)
      - client_id: 'mcp-gateway'
        client_name: 'MCP Gateway'
        # Generate with: docker run --rm authelia/authelia:latest crypto hash generate pbkdf2 --password 'YOUR_SECRET'
        client_secret: '$pbkdf2-sha512$310000$REPLACE_WITH_ACTUAL_HASH'

        # Public client (no secret required from client side for PKCE flow)
        public: false

        # Authorization policy
        authorization_policy: 'two_factor'

        # Redirect URIs (Claude.ai callback, add others as needed)
        redirect_uris:
          - 'https://mcp-gateway.YOUR_TAILNET.ts.net/auth/callback'
          - 'https://claude.ai/oauth/callback'
          # Add other MCP client callbacks here

        # Scopes this client can request
        scopes:
          - 'openid'
          - 'profile'
          - 'email'
          - 'groups'
          # Obsidian scopes
          - 'obsidian:read'
          - 'obsidian:write'
          # Home Assistant scopes
          - 'home:read'
          - 'home:execute'
          # Add custom scopes for your MCP servers
          # - 'myapp:read'
          # - 'myapp:write'

        # Audience (the gateway URL)
        audience:
          - 'https://mcp-gateway.YOUR_TAILNET.ts.net'

        # Grant types
        grant_types:
          - 'authorization_code'
          - 'refresh_token'

        # Response types
        response_types:
          - 'code'

        # Response modes
        response_modes:
          - 'query'
          - 'form_post'

        # Token endpoint auth method
        token_endpoint_auth_method: 'client_secret_post'

        # PKCE challenge method
        pkce_challenge_method: 'S256'

        # Consent mode (explicit = always ask, implicit = remember choice)
        consent_mode: 'implicit'
        pre_configured_consent_duration: '1y'

        # Require PKCE for this client
        require_pkce: true

        # Require pushed authorization requests (optional, more secure)
        require_pushed_authorization_requests: false
